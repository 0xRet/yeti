{% macro display_tags(tags) -%}
  {% if tags is string %}
    <span data-tag="{{tags["name"] or tags}}" class="yeti-tag tag-{{tags["name"] or tags}} label label-default {% if not tags["fresh"]%} yeti-expired {%endif%}">{{tags["name"] or tags}}</span>
  {% elif tags %}
    {% for tag in tags if tag%}<span data-tag="{{tag["name"] or tag}}" class="yeti-tag tag-{{tag["name"] or tag}} label label-default {% if not tag["fresh"]%} yeti-expired {%endif%}">{{tag["name"] or tag}}</span>{% endfor %}
  {% endif %}
{%- endmacro %}

{% macro display_last_analyses(last_analyses) -%}
  {% for last in last_analyses %}
  {{last}} <small>({{display_datetime(last_analyses[last])}})</small>
  {% endfor %}
{%- endmacro %}

{% macro display_datetime(date) -%}
  {% if date %}
    {{ date.strftime("%Y-%m-%d %H:%M") }}
  {% endif%}
{%- endmacro %}

{% macro display_date(date) -%}
  {{ date.strftime("%Y-%m-%d") }}
{%- endmacro %}

{% macro display_context(context) -%}
<div class="panel panel-default yeti-panel">
  <div class="panel-heading">
    <h4 class="panel-title">{{context["source"]}}<span class="small yeti-toggle pull-right" data-target="details-{{context["source"]|replace(" ", "-")}}">[details]</span></h4>
  </div>
  <div class="panel-body panel-collapse" id="details-{{context["source"]|replace(" ", "-")}}" role="tabpanel">
      <table class="table table-condensed">
        {% for key, value in context.items() if key not in ["source"]%}
        <tr><th class="context-key">{{key}}</th><td>{{display_yeti(value, key)}}</td></tr>
        {% endfor %}
      </table>
  </div>
</div>
{%- endmacro%}

{% macro display_yeti(element, key) -%}
  {% if key == "tags" or key == "aliases" %}
    {{display_tags(element)}}
  {% elif key == "last_analyses"%}
    {{display_last_analyses(element)}}
  {% elif key == "created"%}
    {{display_datetime(element)}}
  {% elif key == "pattern" %}
    <code>{{element}}</code>
  {% elif key == "raw" %}
    <pre><code>{{element}}</code></pre>
  {% elif element is string %}
    {{ element }}
  {% else %}
    {{ element }}
  {% endif %}
{%- endmacro %}

{% macro render_field(field) -%}
  {% if field.type in ['CSRFTokenField', 'HiddenField'] %}
    {{ field() }}
  {% else %}
    <div class="form-group {% if field.errors %}error{% endif %}">
      <label for="{{field.name}}">{{field.label}}</label>
        <!-- field is rendered here {{field.type}} -->
        {% if field.type == "TagListField" or field.type == "EntityListField" %}
          {% set _kwargs = {"class_": "tagfield form-control input-sm", "data-choices": url_for(field.endpoint) }%}
          {{ field(**_kwargs)}}
        {% elif field.type == "StringListField" %}
          {% set _kwargs = {"class_": "tagfield form-control input-sm"}%}
          {{ field(**_kwargs)}}
        {% else %}
          {{ field(class_="form-control", **kwargs) }}
        {% endif %}
        {% if field.errors or field.help_text %}
          <p class="help-block">
          {% if field.errors %}
            {{ field.errors|join(' ') }}
          {% else %}
            {{ field.help_text }}
          {% endif %}
          </p>
        {% endif %}
    </div>
  {% endif %}
{% endmacro %}


{% macro render_generic_errors(form) -%}
  {% if form.errors %}
  <div class="alert alert-danger" role="alert">
    {% for field_name, field_errors in form.errors|dictsort if field_errors %}
        {% for error in field_errors %}
          {% if field_name not in form %}
            <p><strong>{{field_name}}</strong> - {{ error }}</p>
          {% else %}
           {{field_name}} - {{error}}
          {% endif %}
        {% endfor %}
    {% endfor %}
  </div>
  {% endif %}
{% endmacro %}

{% macro render(form) -%}
<form action="{{request.path}}" method="POST" class="yeti-form">
{% for field in form %}
  {{ render_field(field) }}
{% endfor %}
<input type="submit" class="btn btn-primary" value="save">
</form>
{% endmacro %}
